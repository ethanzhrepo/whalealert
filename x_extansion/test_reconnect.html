<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NATSé‡è¿åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f8fa;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #1da1f2;
            margin-bottom: 24px;
        }
        
        .status-section {
            margin-bottom: 24px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-connected { background: #17bf63; }
        .status-disconnected { background: #e0245e; }
        .status-reconnecting { 
            background: #ffad1f; 
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .btn {
            background: #1da1f2;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            margin: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background: #1991db;
        }
        
        .btn-danger {
            background: #e0245e;
        }
        
        .btn-danger:hover {
            background: #c91e4a;
        }
        
        .log {
            background: #14171a;
            color: #ffffff;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }
        
        .log-entry {
            margin-bottom: 4px;
        }
        
        .log-timestamp {
            color: #657786;
        }
        
        .log-info { color: #1da1f2; }
        .log-success { color: #17bf63; }
        .log-warning { color: #ffad1f; }
        .log-error { color: #e0245e; }
        
        .config-section {
            margin-bottom: 24px;
        }
        
        .input-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e1e8ed;
            border-radius: 6px;
            box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ NATSé‡è¿åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="config-section">
            <h3>NATSé…ç½®</h3>
            <div class="input-group">
                <label>NATSæœåŠ¡å™¨URL:</label>
                <input type="text" id="natsUrl" value="ws://localhost:4222" placeholder="ws://localhost:4222">
            </div>
            <div class="input-group">
                <label>æµ‹è¯•ä¸»é¢˜:</label>
                <input type="text" id="testSubject" value="test.reconnect" placeholder="test.reconnect">
            </div>
        </div>
        
        <div class="status-section">
            <h3>è¿æ¥çŠ¶æ€</h3>
            <div class="status-item">
                <div class="status-indicator status-disconnected" id="connectionStatus"></div>
                <span id="connectionText">æœªè¿æ¥</span>
            </div>
            <div class="status-item">
                <span>é‡è¿æ¬¡æ•°: <strong id="reconnectCount">0</strong></span>
            </div>
            <div class="status-item">
                <span>æœ€å¤§é‡è¿æ¬¡æ•°: <strong id="maxReconnectCount">10</strong></span>
            </div>
            <div class="status-item">
                <span>è‡ªåŠ¨é‡è¿: <strong id="autoReconnectStatus">å¯ç”¨</strong></span>
            </div>
        </div>
        
        <div>
            <button class="btn" onclick="connect()">è¿æ¥</button>
            <button class="btn btn-danger" onclick="disconnect()">æ–­å¼€</button>
            <button class="btn" onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        
        <div class="log" id="logContainer">
            <div class="log-entry">
                <span class="log-timestamp">[ç­‰å¾…æ“ä½œ]</span>
                <span class="log-info">ç‚¹å‡»"è¿æ¥"å¼€å§‹æµ‹è¯•NATSé‡è¿åŠŸèƒ½</span>
            </div>
        </div>
    </div>

    <script>
        // å¯¼å…¥å·¥å…·ç±»
        const script = document.createElement('script');
        script.src = 'utils.js';
        document.head.appendChild(script);
        
        let natsConnection = null;
        let messageCount = 0;
        
        script.onload = function() {
            log('info', 'å·¥å…·ç±»åŠ è½½å®Œæˆ');
        };
        
        function log(level, message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-${level}">${message}</span>
            `;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        function updateStatus(connected, reconnecting = false, reconnectAttempts = 0) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            const reconnectCountEl = document.getElementById('reconnectCount');
            
            statusIndicator.className = 'status-indicator';
            
            if (connected) {
                statusIndicator.classList.add('status-connected');
                statusText.textContent = 'å·²è¿æ¥';
            } else if (reconnecting) {
                statusIndicator.classList.add('status-reconnecting');
                statusText.textContent = 'é‡è¿ä¸­...';
            } else {
                statusIndicator.classList.add('status-disconnected');
                statusText.textContent = 'æœªè¿æ¥';
            }
            
            reconnectCountEl.textContent = reconnectAttempts;
        }
        
        async function connect() {
            try {
                const url = document.getElementById('natsUrl').value;
                
                if (natsConnection) {
                    natsConnection.disconnect();
                }
                
                log('info', `å°è¯•è¿æ¥åˆ° ${url}`);
                
                natsConnection = new NATSConnection();
                
                // è®¾ç½®è¿æ¥çŠ¶æ€å›è°ƒ
                natsConnection.setConnectionChangeCallback((connected) => {
                    if (connected) {
                        log('success', 'NATSè¿æ¥æˆåŠŸ');
                        updateStatus(true);
                    } else {
                        log('warning', 'NATSè¿æ¥æ–­å¼€');
                        updateStatus(false);
                    }
                });
                
                // ç›‘æ§é‡è¿çŠ¶æ€
                const originalScheduleReconnect = natsConnection.scheduleReconnect;
                natsConnection.scheduleReconnect = function() {
                    const status = this.getStatus();
                    log('warning', `å¼€å§‹é‡è¿... (ç¬¬${status.reconnectAttempts + 1}æ¬¡/${status.maxReconnectAttempts})`);
                    updateStatus(false, true, status.reconnectAttempts + 1);
                    return originalScheduleReconnect.call(this);
                };
                
                await natsConnection.connect([url]);
                log('success', 'è¿æ¥å»ºç«‹æˆåŠŸ');
                updateStatus(true);
                
            } catch (error) {
                log('error', `è¿æ¥å¤±è´¥: ${error.message}`);
                updateStatus(false);
            }
        }
        
        function disconnect() {
            if (natsConnection) {
                log('info', 'æ‰‹åŠ¨æ–­å¼€è¿æ¥');
                natsConnection.disconnect();
                natsConnection = null;
                updateStatus(false);
            } else {
                log('warning', 'æ²¡æœ‰æ´»åŠ¨è¿æ¥');
            }
        }
        
        async function sendTestMessage() {
            if (!natsConnection || !natsConnection.connected) {
                log('error', 'æœªè¿æ¥åˆ°NATSæœåŠ¡å™¨');
                return;
            }
            
            try {
                const subject = document.getElementById('testSubject').value;
                const message = {
                    type: 'test.message',
                    timestamp: Date.now(),
                    count: ++messageCount,
                    data: `æµ‹è¯•æ¶ˆæ¯ #${messageCount}`
                };
                
                await natsConnection.publish(subject, JSON.stringify(message));
                log('success', `æ¶ˆæ¯å·²å‘é€: ${subject} - ${message.data}`);
                
            } catch (error) {
                log('error', `å‘é€æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        }
        
        function clearLog() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="log-entry"><span class="log-timestamp">[æ—¥å¿—å·²æ¸…ç©º]</span><span class="log-info">å‡†å¤‡è®°å½•æ–°çš„æ—¥å¿—</span></div>';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('info', 'NATSé‡è¿æµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('info', 'ä½¿ç”¨è¯´æ˜:');
            log('info', '1. é…ç½®NATSæœåŠ¡å™¨URL');
            log('info', '2. ç‚¹å‡»"è¿æ¥"å»ºç«‹è¿æ¥');
            log('info', '3. åœæ­¢NATSæœåŠ¡å™¨æ¥æµ‹è¯•é‡è¿åŠŸèƒ½');
            log('info', '4. è§‚å¯Ÿé‡è¿æ—¥å¿—å’ŒçŠ¶æ€å˜åŒ–');
        });
    </script>
</body>
</html> 