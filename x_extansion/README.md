# Twitter Monitor Chrome Extension

这是一个Chrome浏览器扩展，用于监控Twitter列表中的新消息并推送到NATS服务器。

## 功能特性

- 🐦 监控指定的Twitter列表页面
- 📡 实时检测新推文并推送到NATS
- ⏰ 记录上次消息时间戳，避免重复推送
- 🔄 支持最多5条最新消息的批量处理
- 🎯 提取推文中的加密货币符号、价格、地址等结构化数据
- 💭 基础情绪分析（利多/利空/中性）
- 🔗 WebSocket连接到NATS服务器
- ⚙️ 可配置的监控间隔和消息数量
- 🔄 **自动重连**: NATS连接断开后自动重连，支持指数退避算法
- 📊 **状态监控**: 实时显示连接状态和重连进度
- 🔄 **自动刷新**: 可配置的页面自动刷新功能，仅在被监控的列表页面生效

## 安装方法

### 1. 开发者模式安装

1. 打开Chrome浏览器
2. 访问 `chrome://extensions/`
3. 开启右上角的"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择 `x_extansion` 文件夹

### 2. 配置扩展

1. 点击扩展图标打开配置面板
2. 配置NATS服务器地址（默认：`ws://localhost:4222`）
3. 设置消息主题（默认：`twitter.messages`）
4. 添加要监控的Twitter列表URL
5. 启用监控功能

## 配置说明

### NATS配置
- **NATS服务器**: WebSocket格式的NATS服务器地址，每行一个
- **消息主题**: 推送消息的NATS主题名称

### 监控设置
- **最大消息数量**: 每次检查时处理的最大新消息数量（1-20）
- **检查间隔**: 定期检查新消息的间隔时间（1000-60000毫秒）

### 自动刷新设置
- **启用自动刷新**: 是否在被监控的列表页面启用自动刷新
- **刷新间隔**: 自动刷新的时间间隔（60-3600秒，建议300秒或更长）

### 监控列表
- 支持的URL格式：
  - `https://twitter.com/i/lists/123456789`
  - `https://x.com/i/lists/123456789`
  - `https://twitter.com/username/lists/listname`

## 消息格式

扩展推送到NATS的消息格式与telegramstream兼容：

```json
{
  "type": "twitter.message",
  "timestamp": 1640995200000,
  "source": "twitter",
  "sender": "x_extension",
  "data": {
    "message_id": "1234567890",
    "list_url": "https://twitter.com/i/lists/123456789",
    "user_id": "username",
    "username": "username",
    "date": 1640995200000,
    "text": "推文内容",
    "raw_text": "推文内容",
    "media": [
      {
        "type": "photo",
        "url": "https://..."
      }
    ],
    "urls": [
      {
        "url": "https://example.com",
        "display_url": "example.com"
      }
    ],
    "extracted_data": {
      "symbols": ["BTC", "ETH"],
      "prices": [
        {
          "price": 50000,
          "currency": "USD"
        }
      ],
      "addresses": {
        "ethereum": ["0x..."],
        "solana": ["..."]
      },
      "sentiment": "positive",
      "keywords": ["pump", "moon"]
    }
  }
}
```

## 与analyze_agent集成

扩展推送的消息可以被analyze_agent处理：

1. 确保analyze_agent的配置文件中包含对twitter消息的支持
2. 在`config.yml`中添加twitter.messages主题到监控列表：

```yaml
nats:
  enabled: true
  servers:
    - 'nats://localhost:4222'
  subject:
    - 'telegram.messages'
    - 'twitter.messages'  # 添加这行
```

## 使用流程

1. **安装扩展**: 按照上述方法安装扩展
2. **配置NATS**: 确保NATS服务器运行并支持WebSocket
3. **添加列表**: 在扩展中添加要监控的Twitter列表URL
4. **启用监控**: 开启监控功能
5. **访问列表**: 在浏览器中打开Twitter列表页面
6. **自动监控**: 扩展会自动检测新推文并推送到NATS

## 技术实现

### 架构组件

- **manifest.json**: 扩展配置文件
- **background.js**: 后台服务脚本，管理NATS连接
- **content.js**: 内容脚本，在Twitter页面监控新推文
- **popup.html/js**: 配置界面
- **utils.js**: 工具类库

### 核心功能

1. **DOM监控**: 使用MutationObserver监控页面变化
2. **消息提取**: 解析推文元素提取结构化数据
3. **时间戳管理**: 记录每个列表的最后消息时间
4. **NATS连接**: WebSocket连接到NATS服务器
5. **去重处理**: 避免重复推送相同消息

### 数据提取

- **用户信息**: 用户名、显示名称
- **推文内容**: 文本内容、发布时间
- **媒体文件**: 图片、视频链接
- **外部链接**: URL和显示文本
- **加密货币**: 符号、价格、钱包地址
- **情绪分析**: 基于关键词的简单情绪判断

## NATS自动重连功能

### 重连机制

扩展内置了强大的NATS自动重连功能，确保在网络不稳定或服务器重启时能够自动恢复连接：

#### 重连特性
- **智能重连**: 连接断开后自动尝试重连
- **指数退避**: 重连间隔逐渐增加（1s → 2s → 4s → 8s → 16s → 30s）
- **持续重试**: 达到最大重连次数后，60秒后重置计数器继续尝试
- **状态监控**: 实时显示连接状态和重连进度
- **手动控制**: 支持手动启用/禁用重连功能

#### 重连配置
- **最大重连次数**: 10次（可在代码中调整）
- **基础延迟**: 1秒
- **最大延迟**: 30秒
- **重置间隔**: 60秒

#### 状态指示
- 🟢 **已连接**: NATS连接正常
- 🟡 **重连中**: 正在尝试重连（带脉冲动画）
- 🔴 **连接失败**: 连接断开或失败

### 测试重连功能

1. 打开 `test_reconnect.html` 测试页面
2. 配置NATS服务器地址
3. 点击"连接"建立连接
4. 停止NATS服务器观察重连行为
5. 重启NATS服务器验证自动恢复

## 自动刷新功能

### 功能说明

自动刷新功能专为解决Twitter列表页面可能不会自动更新的问题而设计。当启用此功能时，扩展会定期刷新被监控的列表页面，确保能够获取到最新的推文内容。

### 特性

- **智能识别**: 只在被监控的Twitter列表页面启用自动刷新
- **可配置间隔**: 支持60秒到3600秒的刷新间隔设置
- **安全机制**: 页面切换时自动停止刷新，避免不必要的刷新
- **状态监控**: 实时记录刷新时间和状态

### 使用建议

1. **推荐间隔**: 建议设置为300秒(5分钟)或更长，避免过于频繁的刷新
2. **网络考虑**: 在网络较慢的环境下，适当增加刷新间隔
3. **电量节省**: 移动设备上建议使用较长的刷新间隔以节省电量

### 工作原理

1. 扩展检测当前页面是否为被监控的Twitter列表
2. 如果是且启用了自动刷新，开始定时器
3. 到达设定时间时，验证页面仍为被监控列表
4. 执行页面刷新操作
5. 页面重新加载后重新开始监控

### 注意事项

- 自动刷新会中断当前的页面操作（如正在编写推文）
- 刷新会重置页面滚动位置
- 频繁刷新可能影响Twitter的使用体验
- 建议在不活跃使用Twitter时启用此功能

## 故障排除

### 常见问题

1. **NATS连接失败**
   - 检查NATS服务器是否运行
   - 确认WebSocket端口是否开放
   - 验证服务器地址格式
   - 查看重连状态和错误信息

2. **无法检测到新推文**
   - 确认Twitter列表URL格式正确
   - 检查页面是否完全加载
   - 查看浏览器控制台错误信息

3. **消息重复推送**
   - 检查时间戳存储是否正常
   - 确认推文ID提取是否正确

4. **重连失败**
   - 检查网络连接是否稳定
   - 确认NATS服务器支持WebSocket
   - 查看重连日志和错误信息
   - 尝试手动断开重连

5. **自动刷新问题**
   - 确认当前页面是被监控的列表页面
   - 检查自动刷新功能是否已启用
   - 验证刷新间隔设置是否合理
   - 查看控制台日志了解刷新状态

### 调试方法

1. 打开Chrome开发者工具
2. 查看Console标签页的日志信息
3. 检查扩展的后台页面日志
4. 验证NATS服务器接收到的消息

## 开发说明

### 本地开发

1. 修改代码后重新加载扩展
2. 在`chrome://extensions/`页面点击刷新按钮
3. 查看控制台输出调试信息

### 代码结构

```
x_extansion/
├── manifest.json       # 扩展配置
├── background.js       # 后台服务
├── content.js         # 内容脚本
├── popup.html         # 配置界面
├── popup.js           # 界面逻辑
├── utils.js           # 工具函数
├── icons/             # 图标文件
└── README.md          # 说明文档
```

## 注意事项

1. **权限要求**: 扩展需要访问Twitter/X.com域名
2. **网络连接**: 需要稳定的网络连接到NATS服务器
3. **页面兼容**: 依赖Twitter页面的DOM结构，可能需要适配更新
4. **性能影响**: 监控功能会消耗一定的CPU和内存资源

## 更新日志

### v1.0.0
- 初始版本发布
- 支持Twitter列表监控
- NATS消息推送
- 基础配置界面
- 消息去重和时间戳管理 